rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User credits collection - secure access
    match /userCredits/{userId} {
      // Allow users to read only their own credits
      allow read: if true;  // Allow all reads for now (extension needs to read credits)
      
      // Allow creating credits document (for initialization)
      allow create: if true;  // Allow creation for new users
      
      // Allow updates only through background script
      // The update must not change totalCreditsUSD and can only increase usedCreditsUSD
      allow update: if request.resource.data.totalCreditsUSD == resource.data.totalCreditsUSD
                    && request.resource.data.usedCreditsUSD >= resource.data.usedCreditsUSD
                    && request.resource.data.remainingCreditsUSD == request.resource.data.totalCreditsUSD - request.resource.data.usedCreditsUSD;
      
      // Prevent deletion
      allow delete: if false;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

